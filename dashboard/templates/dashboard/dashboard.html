{% extends 'dashboard/layout.html' %}

{% block filter_form %}
    <form name="filters">
        <select name="irrelevant">
            <option value="">istotne i nieistotne</option>
            <option value="F">tylko istotne</option>
            <option value="T">tylko nieistotne</option>
        </select>
        <select name="direction">
            <option value="">przychody i wydatki</option>
            <option value="I">tylko przychody</option>
            <option value="O">tylko wydatki</option>
        </select>
        {% if accounts_list %}
            <select name="account">
                <option value="">Wszystkie konta</option>
                {% for account in accounts_list %}
                    <option value="{{ account.account__id }}"> {{ account.account__bank__name }}: {{ account.account__name }} </option>
                {% endfor %}
            </select>
        {% else %}
            <input type="hidden" name="account" value="">
        {% endif %}
        <button onclick="load_transactions(); return false;">&#x21bb;</button>
    </form>
{% endblock %}

{% block monthly_review %}
    <h3>Monthly review</h3>
    {% if months_list %}
        <ul>
        {% for month in months_list %}
            <li>{{ month.month }}: <strong>{{ month.total|floatformat:2  }}</strong>; UP: {{ month.up|floatformat:2  }}; DOWN: {{ month.down|floatformat:2 }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No transactions are available.</p>
    {% endif %}

{% endblock %}

{% block transactions_review %}
    <h3>Transactions review</h3>



    <div class="table-responsive">
        <table class="table table-striped table-sm" id="transactions_table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- filled through Ajax -->
            </tbody>
        </table>
    </div>
{% endblock %}

{% block accounts_info %}
    <div class="accordion" id="accountAccordion">
        <div>
            <div>
                <div>

        {% if accounts_list %}
            {% for account in accounts_list %}
                {% ifchanged account.account__bank__name %}
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header" id="heading{{ account.account__bank__id }}" style="padding: 2px">
                            <button class="btn btn-link {% if account.account__bank__hide == 1 %}collapsed{% endif %}" type="button" data-toggle="collapse"
                                        data-target="#collapse{{ account.account__bank__id }}" aria-expanded="true"
                                        aria-controls="collapse{{ account.account__bank__id }}" style="padding: 2px">
                                    {{ account.account__bank__name }}
                            </button>
                        </div>
                        <div id="collapse{{ account.account__bank__id }}" class="collapse {% if account.account__bank__hide != 1 %}show{% endif %}"
                             aria-labelledby="heading{{ account.account__bank__id }}"
                             data-parent="#accountAccordion">
                            <div class="card-body" style="padding: 5px">
                {% endifchanged %}

                                <div>
                                    <div>{{ account.account__name }}</div>
                                    <div class="text-right"><strong>{{ account.total|floatformat:2 }}</strong> {{ account.account__currency__name }}</div>
                                </div>
            {% endfor %}
        {% else %}
            <p>No accounts are available.</p>
        {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_js %}

    {% csrf_token %}
    <script>
        var csrftoken = $("[name=csrfmiddlewaretoken]").val();

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function fill_transaction_row(e, rowToFill) {
            // date
            dateCell = document.createElement("td");
            $(dateCell).html(e.date);
            rowToFill.appendChild(dateCell);

            // transaction
            transactionCell = document.createElement("td");
            if (e.irrelevant) {
                transactionCell.style.color = '#aaa';
            }
            transactionCell.innerHTML = e.description + '<div class="text-right">category: ' + e.category__name + '</div>' +
                    '<div class="text-right">account: ' + e.account__bank__name + ' - ' + e.account__name + '; type: ' + e.type + '</div>';
            rowToFill.appendChild(transactionCell);

            // amount
            amountCell = document.createElement("td");
            amountCell.setAttribute('class','text-right');
            amountCell.innerHTML = e.amount_account_currency + ' ' + e.account__currency__name;
            rowToFill.appendChild(amountCell);

            return rowToFill;
        }

        function fill_transactions(t) {
            var bodyToFill = $('#transactions_table tbody');
            var lastDate;

            bodyToFill.empty();

            t.forEach(function(e){
                thisRow = document.createElement("tr");
                thisRow.setAttribute('data-transaction-id', e.id);
                if (lastDate != e.date) {
                    thisRow.style.borderTop = "4px solid black";
                    lastDate = e.date;
                }

                thisRow = fill_transaction_row(e, thisRow);


                bodyToFill.append(thisRow);
            });
        }

        function load_transactions() {
            $('#transactions_table').addClass('loading');

            $.ajax({
                type: "POST",
                url: /j_transactions/,
                data: $(document.filters).serialize(),
                success: function(data) {
                    if (data.transactions_list) {
                        fill_transactions(data.transactions_list);
                    } else {
                        alert('transactions not loaded');
                    }
                    $('#transactions_table').removeClass('loading');
                },
                dataType: 'json',
                failure: function(errMsg) {
                    $('#transactions_table').removeClass('loading');
                    alert(errMsg);
                }
            });
        }

        $(function(){
            load_transactions();
        });
    </script>
{% endblock %}